LIBRARY ieee;
USE ieee.std_logic_1164.ALL;
USE ieee.numeric_std.ALL;

ENTITY fir1 IS
      GENERIC(WIDTH:INTEGER:=16;
              N:INTEGER:=16);
      PORT(reset: IN STD_LOGIC;
           start: IN STD_LOGIC;
           clk: IN STD_LOGIC;
           x:IN STD_LOGIC_VECTOR(WIDTH-1 DOWNTO 0);
           y:OUT STD_LOGIC_VECTOR(2*WIDTH-1 DOWNTO 0);
--         y:OUT STD_LOGIC_VECTOR(WIDTH-1 DOWNTO 0);
           finished:OUT STD_LOGIC);
   END fir1;
   
     
    ARCHITECTURE calc OF fir1 IS
      
      TYPE memory is array (0 to N) of
           std_logic_vector(WIDTH-1 DOWNTO 0);
           
      TYPE memory_2 is array (0 to N-1) of
           std_logic_vector(WIDTH-1 DOWNTO 0);
           
           
      --SIGNALS AND CONSTANTS
      SIGNAL coefficients:memory;
      
      
      SIGNAL x_n:memory_2; 
      SIGNAl y_sum:std_logic_vector(2*WIDTH-1 DOWNTO 0);
      SIGNAL start_2:STD_LOGIC;
      SIGNAl fin:STD_LOGIC;
      SIGNAL i:INTEGER;
      
       BEGIN
                            
    PROCESS (reset,clk)
      BEGIN   
         IF (reset='1') THEN
          --reset things

 --coefficients for 0.247000247(work)
         
          coefficients<= (
          "0000000000000000", 
          "0000000000000011", 
          "0000000000000111", 
          "0000000000001011", 
          "0000000000010000", 
          "0000000000010101", 
          "0000000000011010", 
          "0000000000011111", 
          "0000000000100100", 
          "0000000000101001", 
          "0000000000101100", 
          "0000000000101101", 
          "0000000000101011", 
          "0000000000100111", 
          "0000000000011110", 
          "0000000000010001", 
          "1111111111111111", 
          "1111111111101001", 
          "1111111111001111", 
          "1111111110110001", 
          "1111111110010001", 
          "1111111101101111", 
          "1111111101001110", 
          "1111111100101111", 
          "1111111100010101", 
          "1111111100000010", 
          "1111111011111001", 
          "1111111011111100", 
          "1111111100001101", 
          "1111111100101110", 
          "1111111101100001", 
          "1111111110100111", 
          "0000000000000000", 
          "0000000001101011", 
          "0000000011101001", 
          "0000000101110111", 
          "0000001000010010", 
          "0000001010111001", 
          "0000001101100110", 
          "0000010000010110", 
          "0000010011000101", 
          "0000010101101101", 
          "0000011000001010", 
          "0000011010011001", 
          "0000011100010011", 
          "0000011101110110", 
          "0000011111000000", 
          "0000011111101101", 
          "0000011111111100", 
          "0000011111101101", 
          "0000011111000000", 
          "0000011101110110", 
          "0000011100010011", 
          "0000011010011001", 
          "0000011000001010", 
          "0000010101101101", 
          "0000010011000101", 
          "0000010000010110", 
          "0000001101100110", 
          "0000001010111001", 
          "0000001000010010", 
          "0000000101110111", 
          "0000000011101001", 
          "0000000001101011", 
          "0000000000000000", 
          "1111111110100111", 
          "1111111101100001", 
          "1111111100101110", 
          "1111111100001101", 
          "1111111011111100", 
          "1111111011111001", 
          "1111111100000010", 
          "1111111100010101", 
          "1111111100101111", 
          "1111111101001110", 
          "1111111101101111", 
          "1111111110010001", 
          "1111111110110001", 
          "1111111111001111", 
          "1111111111101001", 
          "1111111111111111", 
          "0000000000010001", 
          "0000000000011110", 
          "0000000000100111", 
          "0000000000101011", 
          "0000000000101101", 
          "0000000000101100", 
          "0000000000101001", 
          "0000000000100100", 
          "0000000000011111", 
          "0000000000011010", 
          "0000000000010101", 
          "0000000000010000", 
          "0000000000001011", 
          "0000000000000111", 
          "0000000000000011", 
          "0000000000000000" 
                        );
                          
          y_sum<=(OTHERS=>'0');
         
          for k in 0 to N-1 loop
             x_n(k)<=(OTHERS=>'0');
          end loop;
          
          start_2<='0';
          fin<='0';
          i<=0;
					finished<='0';
          
         ELSIF (rising_edge(clk)) THEN
           
            IF (start='1' AND start_2='0') THEN
                  
                  x_n(0)<=x;
                  y_sum<=(OTHERS=>'0');
                  start_2<='1';
                  i<=0;
									finished<='0';
									fin<='0';
			                  
            ELSIF (start_2='1' AND fin='0') THEN
               
              y_sum<=std_logic_vector(signed(y_sum)+
              signed(shift_left(signed(signed(coefficients(i))*signed(x_n(i))),1)));
              
              i<=i+1;
              
              IF (i=N-1) THEN
                fin<='1';
              END IF;
      
           ELSIF (start_2='1' AND fin='1' )THEN
             
             y<=y_sum;
             
            for j in 0 to N-2 loop
             x_n(j+1)<=x_n(j);
            end loop;
            
            finished<='1';
            start_2<='0';
            fin<='0';
            
            END IF;
          END IF;
    END PROCESS; 
            
            
END calc; 
   

